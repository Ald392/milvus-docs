# 特征向量数据库简介

## 特征向量
在现实世界中，对于复杂而多元的事物，我们是很难使用简单的数据类型进行描述的。例如：我们很难用几个简单的数字来精确的描述一张人脸，因为人脸由43块肌肉构成，想要精确的描述一张人脸，通常需要一百维的向量进行描述。所以，对于复杂的事物，我们通常会使用特征向量类型来进行表示。同时，特征向量的维度越高，一般也就能够更精确的描述这个事物的特征。

AI、机器学习、深度学习等近年来热门的技术，其核心的能力就是利用各种计算机算法对现实世界的原始数据进行特征提取，特征处理和特征选择，最终形成准确描述该事物的特征向量。

随着近年来计算机技术的不断进步，特别是以NVIDIA的GPU为代表的新一代异构众核高性能计算芯片的诞生，使得深度学习技术的应用得到了长足的进步。但是无论是目前基于卷积神经网络(CNN)的深度学习系统，还是当前火热的基于循环神经网络(RNN)的深度学习系统，其训练出来的模型在用于实际预测的时候，都是将输入的事物以高维特征向量的形式输出的。下面将列举一些具体的机器学习或者深度学习的应用场景：

- 在人脸识别的领域，2018年3月来自中国的DeepInsight团队的使用InsightFace人脸识别库的深度学习技术，训练出来的模型，取得了MegaFace人脸识别比赛的第一名，其产生的人脸特征向量为512维，识别率超过98%。

- 在自然语言处理领域，Google的word2vector算法可以算是基石算法，其原理就是把自然语言中的字和词转化为300维的词向量。然后再利用词向量在向量空间上的位置，就可以度量出词与词的关系。

- 在语音识别领域，无论是前几年最热门的基于RNN/LTSM方案，还是现在基于注意力模型的方案，首先需要解决的就是对语音提取其特征向量，然后才能展开后续分析。

由上面的这些例子，我们发现特征向量，特别是高维特征向量在当前和未来的AI领域，都扮演着表达世界万事万物基础数据类型的角色。

因此，在海量的特征向量中能够精确而高效地进行检索，也就越来越成为AI技术大规模应用的必要条件，同时也是对传统数据库系统的一个挑战。

## 传统数据库
那么传统数据库系统和大数据系统，在向量相似性检索领域的表现会怎么样呢？

随着机器学习或者深度学习技术越来越成熟，应用越来越广泛，随之而产生的特征向量数据也会越来越庞大。传统的数据库系统和大数据系统，由于其内建数据类型里并不包括特征向量类型。如果打算使用传统的数据库系统进行特征向量检索，要么自定义特征向量类型以及针对该类型数据的自定义函数；要么就只能按照一维一列的方式把高维向量存入数据库系统。由于大多数数据库系统对于表列数的支持都是有限的，因此使用这种方法通常无法支持高维特征向量。

此外，传统的数据库和大数据系统里，除了没有针对该数据类型的存储方式、计算方法，也没有针对该类型的索引方式以及数据的管理方式，由此可见使用传统的数据库和大数据系统进行特征向量的存储和检索，都是不合适的。

当然，现在一些传统数据库系统也提供了针对特征向量检索的插件：例如，PostgreSQL的以图搜图插件imgsmlr和自然语言处理的插件word2vector，但是由于传统数据库系统，本身是针对基于哈希搜索或者基于一维离散数据搜索而优化的，并没有针对高维向量搜索进行优化，所以这些插件虽然能用，但是功能也不强大，效率也很低，并不能满足海量高维向量的搜索。

## 向量检索算法
通常来说，面向向量的相似性检索的方法分成：精确检索和近似检索两类。而精确检索的本质就是线性查找：

### 线性查找

通过在整个向量空间内，遍历所有已存向量计算其与检索向量的距离，通常是计算欧几里德距离或者点积。欧式距离最近的向量或者点积最大的向量就是相似度最高的向量。线性查找算法简单，不需要建立额外的数据结构和存储空间，通过使用例如Intel架构下的MKL或者使用NVIDIA GPU的cublas等并行计算库加速，对于中小规模的向量集的相似性检索是合适的。但是，由于线性查找的时间复杂度是O(Nd)，其中N是向量集的规模，d是向量的维度，随着向量集的规模的增大或者向量维度的增加，线性查找就会显得力不从心。

### 近似检索

所谓近似检索，就是通过聚类、降维或者编码等方式，将原来需要在全量高维向量空间内的搜索，转换为在小范围空间或者相对低维的向量空间内搜索的算法。这类算法的特点是，检索的时间复杂度小于O(Nd)，但是真正用来搜索之前，需要用一个向量分布类似的一个训练集来训练，获得一个产生合理数据划分或者编码的模型。然后再利用这个模型，使用额外的存储空间，建立对全量高维向量的索引。目前近似检索的算法，通常分为：基于树的搜索算法，基于哈希的空间划分法和向量量化的编码法。

- 基于树的搜索算法

基于树的搜索算法是一个以树为数据结构的近似最近邻搜索算法。其核心是不断用选取的两个质心的法平面对空间进行分割，最终将每一个区分的子空间里面的样本数据限制在K以内。对于待插入的样本Xi，从根节点依次使用法向量跟Xi做内积运算，从而判断使用法平面的哪一边（左子树or右子树）。对于查询向量Qi，采用同样的方式（在树结构上体现为从根节点向叶子节点递归遍历），即可定位到跟Qi在同一个子空间或者邻近的子空间的样本，这些样本即为Qi近邻。实际应用中还可以通过建立多棵树的方式，提高查询的准确率。

- 基于哈希的空间划分法

基于哈希的空间划分法是利用哈希函数对把需要搜索的特征空间，划分称为多个子空间。然后把带插入的向量根据前面的哈希函数，聚类到不同的子空间中，一般来说相同子空间内向量的空间距离相对更接近。然后把这些向量分别记录在每个子空间的倒排列表中。对于查询向量的来说，首先也是用哈希函数找到和这个向量最近的一个或多个子空间。然后再根据子空间中心点到该向量的距离，由近及远，计算其倒排列表中所有向量与查询向量的距离。最后根据距离，选出距离最近的k个向量作为返回结果。

- 向量量化的编码算法

向量量化方法的本质也是聚类，它的方法是这样的：在训练阶段，针对训练样本集合，会将其样本维度d进行切分。假设切分为n个子空间，每个子空间的维度就是d/n。然后再在每个子空间中，对子向量进行聚类，如此每个子空间都可以获得一个编码集。这样训练样本的每个子段，都可以用子空间聚类中心来近似，对应的编码也就是类中心的ID了。通过这样的编码方式，训练样本就可以用很短的编码进行表示，从而达到量化的目的。对于待编码的数据，使用相同的切分方案，完成所有编码。如此，在查询向量到来的时候，原先全样本的距离计算，就可以转化为子空间聚类中心的距离计算，从而大大简化了向量检索的时间。此外，由于该算法对特征向量进行编码后的信息较短，其额外的空间占用率也并不高。但是，该算法的精度与子空间划分的大小和编码长度有的关系。目前，该类算法的查询性能优秀，但是精度较其他算法要低。

除了上面提到的三类算法，近年来基于邻近图的最近邻搜索算法，在向量检索领域开始突破。邻近图算法的核心思想也是聚类，通过把距离最近的向量，用图连接的方式连接起来。这样当我们在查询的时候，就可以利用"邻居的邻居也可能是邻居"的原理，找到最相似的向量。

## 特征向量数据库
既然特征向量检索是未来人工智能技术大规模应用的必要条件，那市场上目前关于特征向量检索有哪些具体实现呢？

### FAISS

FAISS 是 Facebook AI 研究团队开源的针对聚类和相似性搜索库。FAISS 是用 C++ 编写的，带有 Python / numpy 的完整封装。FAISS大量利用了：

- 多线程以充分利用多核性能并在多路 GPU 上进行并行搜索。
- BLAS 算法库通过 matrix/matrix 乘法进行高效、精确的距离计算。没有 BLAS，高效的强力执行很难达到最优状态。 BLAS/LAPACK 是唯一一个 Faiss 必须的前提软件。
- 机器 SIMD 矢量化和 popcount 被用于加速孤立矢量的距离计算。

FAISS包含了多种向量检索算法，提供不同精度，查询速度和存储空间占用率。它还包含用于评估和参数调整的支持代码。 FAISS的出现也打破了过去向量检索库的一个限制：只能提供某个方面的优化。FAISS允许开发人员，在建立索引的速度、查询速度、内存使用量和查询精度等多个方面做取舍。

FAISS虽然有上述的种种优点，但是依然只是一个算法库；虽然提供了多种算法和参数以供调优，但是对于开发人员而言，想用好FAISS依然有很高的门槛。

### SPTAG

SPTAG是由Microsoft于2019年5月发布的，基于最近邻搜索的向量检索算法。开发人员称该算法：允许用户充分利用学习模型在以毫秒为单位时间内智能搜索数十亿条向量。该算法在查询速度、查询精确度以及内存占用上也都有非常好的表现。和NSG类似，SPTAG建图的过程非常漫长，所以在需要大量插入新向量的同时进行查询的场景下，SPTAG也并不合适。

综上所述，当前工业界针对向量检索的实现中，并没有一个能擅长所有场景的万能算法。同时现有的实现也都还只是算法库，而并非一个系统。随着AI应用的大规模落地，提供一个面向海量特征向量检索的数据库系统，已经是市场对于数据库厂商提出的新需求。

## Milvus特征向量数据库

Milvus是Zilliz公司针对AI应用大规模落地，当前工业界并没有一款成熟向量检索系统，而研制的面向海量特征向量检索的数据库系统，旨在帮助用户实现非结构化数据的近似检索和分析。其实现原理是通过AI算法提取非结构化数据的特征，然后利用特征向量唯一标识该非结构化数据，最后用向量间的距离衡量非结构化数据之间的相似度。

与当前工业界其它向量检索工具相比，Milvus具有以下性能优势：

|                   |Milvus    |  FAISS  |   SPTAG   |
|-------------------|----------|---------|-----------|
|CPU/GPU异构计算能力 | Yes      |  Yes    |    No     |
|量化索引           |   Yes     |  Yes    |    No     |









